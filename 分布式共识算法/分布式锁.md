### 一、分布式锁

分布式场景下，需要同步的进程位于不同的节点上，那么就需要使用分布式锁。

#### 1.Redis的setnx指令

使用set if not exist指令插入一个健值对，如果Key已经存在，就返回false，不存在就插入成功。它可以保证只存在一个key的健值对，那么可以用一个key的健值对是否存在来判断是否处于锁定状态。还可以为这个key设置过期时间。

#### 2.Redis的RedLock算法

使用了多个Redis实例来实现分布式锁，这是为了保证发生单点故障的时候依然可用。分为三个步骤：

1.尝试从N个互相独立的Redis实例获取锁。

2.计算获取锁消耗的时间，只有这个时间小于锁的过期时间，并且大多数实例获取到了锁，就认为是加锁成功。

3.如果获取失败，就到每个实例上释放锁。

#### 3.ZK的有序节点

1.zk抽象模型：zk提供了一种树形结构的命名空间。

2.节点类型：永久节点：不会因为绘画结束或者超时而消失。临时节点：如果会话结束或者超时就消失。有序节点：会在节点名的后面加一个数字后缀，并且是有序的，例如生成的有序节点为 /lock/node-0000000000，它的下一个有序节点则为 /lock/node-0000000001，以此类推。

3.监听器：为节点注册一个监听器，在节点状态改变的时候，会给客户端发消息。

4.分布式锁的实现：

1）创建一个锁目录/lock

2）当一个客户端需要获取锁时，在/lock下创建临时的且有序的子节点。

3）客户端获取 /lock 下的子节点列表，判断自己创建的子节点是否为当前子节点列表中序号最小的子节点，如果是则认为获得锁；否则监听自己的前一个子节点，获得子节点的变更通知后重复此步骤直至获得锁；

4）执行业务代码，完成后，删除对应的子节点。

5.会话超时

如果一个已经获得锁的会话超时了，执行业务代码，因为创建的是临时节点，所以该会话对应的临时节点会被删除，其它会话就可以获得锁了。也就是这个锁也是有过期时间的。

6.羊群效应

一个节点未获取锁，只需要监听自己的前一个子节点，这是因为如果监听所有的子节点，那么任意一个子节点状态改变，其它所有子节点都会收到通知（羊群效应），而我们只希望它的后一个子节点收到通知。



### 二、分布式事务

事务的操作位于不同的节点上，需要保证事务的ACID特性。比如你一个产生订单和扣钱的操作在两个系统上，如果扣钱失败了，那么订单是需要回滚的，这就涉及分布式事务。

#### 1.   2PC

通过引入协调者来协调参与者的行为，并最终决定这些参与者是否要真正执行事务。

##### 1.准备阶段

协调者询问参与者事务是否执行成功，参与者发回事务的执行结果。

##### 2.提交阶段

如果事务在每个参与者都执行成功，那么事务协调者就让他们各自提交任务，否则通知他们回滚事务。需要注意的是，在准备阶段，参与者执行了事务但还没提交。

#### 2.  2PC存在的问题

所有事务参与者在等待其他参与者响应的时候都处于同步阻塞的状态，无法进行其他操作。而且如果协调者挂了，那这个就没法进行了，而且在第二个提交的阶段，万一有的节点没有收到提交或者回滚的通知，就产生不一致了。而且，任意一个节点失败，整个事务都失败了，都没有给他重试的机会吗？

#### 2.本地消息列表

其实这个就是利用了消息队列，让一方先把做的操作发到mq里面，后面的系统去mq读，然后继续操作。

#### 三、CAP

cap说的就是分布式系统不了能同时满足：一致性、可用性、分区容忍性。最多只能满足两项。

一致性说的是多个数据副本是否能保持一致性，对系统的一个数据更新成功之后，如果所有的用户都可以读到最新的值，那么系统就是有强一致性。

可用性，可用性指分布式在面对各种异常时可以提供服务。

分区容忍性，分区指分布式系统中的节点被划分为多个区域，每个区域内部可以通信，但是区域之间无法通信。在分区容忍性条件下，分布式系统在遇到任何网络分区故障的时候，仍然需要能对外提供一致性和可用性的服务，除非是整个网络环境都发生了故障。

##### 权衡

在分布式系统中，分区容忍性必不可少，因为需要总是假设网络是不可靠的。因此，CAP 理论实际上是要在可用性和一致性之间做权衡。

可用性和一致性往往是冲突的，很难使它们同时满足。在多个节点之间进行数据同步时，

- 为了保证一致性（CP），不能访问未同步完成的节点，也就失去了部分可用性；
- 为了保证可用性（AP），允许读取所有节点的数据，但是数据可能不一致。

#### 三、Paxos

用于达成共识性问题，即多个节点产生的值，该算法能保证只选出唯一一个值。

主要有三类节点：

1.提议者：题意一个值

2.接受者：对每个提议进行投票

3.告知者：被告知投票的结果，不参与投票过程

