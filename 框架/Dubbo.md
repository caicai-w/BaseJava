### 1.什么是Dubbo

rpc框架，提供了三大核心能力：面向接口的远程方法调用，智能容错和负载均衡，服务自动注册和发现。

### 2.什么是RPC？RPC原理是什么？

rpc远程过程调用，就是通过网络从远程计算机请求服务。比如A、B两个服务部署在两个不同的机器上，那么服务A如果想要调用B中的某个方法该怎么办，当然http请求可以，但可能会比较慢而且一些优化做的不好。rpc出现就是为了解决这个问题。

rpc原理大概是什么？或者说调用过程？

![](https://camo.githubusercontent.com/c54a1fc956b7d9f9c72db3ca1f8928069c28242b/687474703a2f2f6d792d626c6f672d746f2d7573652e6f73732d636e2d6265696a696e672e616c6979756e63732e636f6d2f31382d31322d362f33373334353835312e6a7067)

1.client，服务消费方以本地调用方式调用服务。

2.client stub接收到调用后把方法、参数组装成能够进行网络传输的消息体。

3.client stub找到服务地址，并将消息发送服务端。

4.server stub收到消息后进行解码。

5.server stub根据解码结果调用本地的服务。

6.本地服务执行并将结果返回给server stub

7.server stub将返回结果打包成消息并发送至消费方

8.client stub接收到消息，并进行解码。

9.服务消费方得到最终结果。

### 3.为什么要用Dubbo？

Dubbo的诞生和面向服务的SOA分布式架构流行于关系，如果要开发分布式程序，你也可以直接基于HTTP接口进行通信，但为什么用Dubbo？

那么，可以从下面几个方面考虑：负载均衡，同一个服务部署在不同的机器时应该调用哪一个服务呢？dubbo的负载均衡可以给你做。还有就是服务降级，某个服务挂掉之后调用备用服务，还有基于访问压力实时管理集群容量，提高集群利用率。

另外，dubbo除了能够应用在分布式系统中，也可以应用在现在比较火的微服务里面，不过，由于Spring Cloud在微服务中应用更广泛，所以，一般说dubbo都是在分布式系统的场景。

### 4.Dubbo的架构

![](https://camo.githubusercontent.com/de61194de3bf11adcc16e0da0b12ff90bc9fe417/687474703a2f2f6d792d626c6f672d746f2d7573652e6f73732d636e2d6265696a696e672e616c6979756e63732e636f6d2f31382d392d32362f34363831363434362e6a7067)

调用关系说明：服务容器负责启动、加载，运行服务提供者，并且服务提供者需要向注册中心注册自己提供的服务。 

服务消费方在启动时，向注册中心订阅自己需要的服务，注册中心返回服务提供者的地址列表给消费者，如果有变更，注册中心将基于长链接推送变更数据给消费者。 

服务消费者从提供者的地址列表里，基于软件复杂均衡，选一台调用，如果失败就再选一台。

**总结：**注册中心负责服务地址的查找和注册，服务提供者和消费者只有在启动的时候和注册中心交互。

监控中心负责统计各个服务的调用次数，调用时间，统计先在内存汇总后每分钟一次发送到监控中心服务器，并以报表展示。

注册中心，服务提供者、消费者、三者之间均为长链接，监控中心除外。

注册中心通过长链接感知服务提供者的存在，消费者服务一旦宕机，注册中心将立即推送事件通知消费者。

注册中心和监控中心全部宕机，不影响已运行的提供者和消费者，消费者在本地缓存了提供者列表。

服务提供者任意一台宕机不影响整体使用，如果全宕掉，服务消费方会无限次重连等待服务提供者恢复。

### 5.Dubbo工作原理

### 6.Dubbo的负载均衡

LoadBalance 中文意思为负载均衡，它的职责是将网络请求，或者其他形式的负载“均摊”到不同的机器上。避免集群中部分服务器压力过大，而另一些服务器比较空闲的情况。通过负载均衡，可以让每台服务器获取到适合自己处理能力的负载。在为高负载服务器分流的同时，还可以避免资源浪费，一举两得。负载均衡可分为软件负载均衡和硬件负载均衡。在我们日常开发中，一般很难接触到硬件负载均衡。但软件负载均衡还是可以接触到的，比如 Nginx。在 Dubbo 中，也有负载均衡的概念和相应的实现。Dubbo 需要对服务消费者的调用请求进行分配，避免少数服务提供者负载过大。服务提供者负载过大，会导致部分请求超时。因此将负载均衡到每个服务提供者上，是非常必要的。Dubbo 提供了4种负载均衡实现，分别是基于权重随机算法的 RandomLoadBalance、基于最少活跃调用数算法的 LeastActiveLoadBalance、基于 hash 一致性的 ConsistentHashLoadBalance，以及基于加权轮询算法的 RoundRobinLoadBalance。

##### RandomLoadBalance

RandomLoadBalance 是加权随机算法的具体实现。假设我们有一组服务器 servers = [A, B, C]，他们对应的权重为 weights = [5, 3, 2]，权重总和为10。现在把这些权重值平铺在一维坐标值上，[0, 5) 区间属于服务器 A，[5, 8) 区间属于服务器 B，[8, 10) 区间属于服务器 C。接下来通过随机数生成器生成一个范围在 [0, 10) 之间的随机数，然后计算这个随机数会落到哪个区间上。比如数字3会落到服务器 A 对应的区间上，此时返回服务器 A 即可。权重越大的机器，在坐标轴上对应的区间范围就越大，因此随机数生成器生成的数字就会有更大的概率落到此区间内。只要随机数生成器产生的随机数分布性很好，在经过多次选择后，每个服务器被选中的次数比例接近其权重比例。
当调用次数比较少时，Random 产生的随机数可能会比较集中，此时多数请求会落到同一台服务器上。这个缺点并不是很严重，多数情况下可以忽略。RandomLoadBalance 是一个简单，高效的负载均衡实现，因此 Dubbo 选择它作为缺省实现。

##### LeastActiveLoadBalance

LeastActiveLoadBalance 翻译过来是最小活跃数负载均衡。活跃调用数越小，表明该服务提供者效率越高，单位时间内可处理更多的请求。此时应优先将请求分配给该服务提供者。在具体实现中，每个服务提供者对应一个活跃数 active。初始情况下，所有服务提供者活跃数均为0。每收到一个请求，活跃数加1，完成请求后则将活跃数减1。在服务运行一段时间后，性能好的服务提供者处理请求的速度更快，因此活跃数下降的也越快，此时这样的服务提供者能够优先获取到新的服务请求、这就是最小活跃数负载均衡算法的基本思想。除了最小活跃数，LeastActiveLoadBalance 在实现上还引入了权重值。所以准确的来说，LeastActiveLoadBalance 是基于加权最小活跃数算法实现的。举个例子说明一下，在一个服务提供者集群中，有两个性能优异的服务提供者。某一时刻它们的活跃数相同，此时 Dubbo 会根据它们的权重去分配请求，权重越大，获取到新请求的概率就越大。如果两个服务提供者权重相同，此时随机选择一个即可。

##### ConsistentHashLoadBalance

它的工作过程是这样的，首先根据 ip 或者其他的信息为服务提供者节点生成一个 hash，并将这个 hash 投射到 [0, 232 - 1] 的圆环上。当有查询时，则根据请求生成一个 hash 值。然后查找第一个大于或等于该 hash 值的服务提供者，并到这个节点中查询。如果当前节点挂了，则在下一次查询时，查找另一个大于其 hash 值的节点即可。大致效果如下图所示，每个缓存节点在圆环上占据一个位置。如果缓存项的 key 的 hash 值小于缓存节点 hash 值，则到该缓存节点中存储或读取缓存项。比如下面绿色点对应的缓存项将会被存储到 cache-2 节点中。由于 cache-3 挂了，原本应该存到该节点中的缓存项最终会存储到 cache-4 节点中。

##### RoundRobinLoadBalance

加权轮询。这里从最简单的轮询开始讲起，所谓轮询是指将请求轮流分配给每台服务器。举个例子，我们有三台服务器 A、B、C。我们将第一个请求分配给服务器 A，第二个请求分配给服务器 B，第三个请求分配给服务器 C，第四个请求再次分配给服务器 A。这个过程就叫做轮询。轮询是一种无状态负载均衡算法，实现简单，适用于每台服务器性能相近的场景下。但现实情况下，我们并不能保证每台服务器性能均相近。如果我们将等量的请求分配给性能较差的服务器，这显然是不合理的。因此，这个时候我们需要对轮询过程进行加权，以调控每台服务器的负载。经过加权后，每台服务器能够得到的请求数比例，接近或等于他们的权重比。比如服务器 A、B、C 权重比为 5:2:1。那么在8次请求中，服务器 A 将收到其中的5次请求，服务器 B 会收到其中的2次请求，服务器 C 则收到其中的1次请求。
